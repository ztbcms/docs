<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>云存储模块 !version | ZTBCMS</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/img/logo.png">
    <meta name="description" content="高性能、模块化、极速开发PHP Web框架">
    
    <link rel="preload" href="/assets/css/0.styles.35bcedcf.css" as="style"><link rel="preload" href="/assets/js/app.dfdc7237.js" as="script"><link rel="preload" href="/assets/js/2.337bf37a.js" as="script"><link rel="preload" href="/assets/js/84.b52b4bd1.js" as="script"><link rel="prefetch" href="/assets/js/10.4612b85f.js"><link rel="prefetch" href="/assets/js/100.b9a40a47.js"><link rel="prefetch" href="/assets/js/101.7e2a9f76.js"><link rel="prefetch" href="/assets/js/102.35239c18.js"><link rel="prefetch" href="/assets/js/103.ea563f80.js"><link rel="prefetch" href="/assets/js/104.99c64bbf.js"><link rel="prefetch" href="/assets/js/105.1d1176a6.js"><link rel="prefetch" href="/assets/js/106.3c5e8fe8.js"><link rel="prefetch" href="/assets/js/107.39f0e4a1.js"><link rel="prefetch" href="/assets/js/108.af88ca74.js"><link rel="prefetch" href="/assets/js/109.c0faafe3.js"><link rel="prefetch" href="/assets/js/11.42d71234.js"><link rel="prefetch" href="/assets/js/110.15af8084.js"><link rel="prefetch" href="/assets/js/111.6b85bcb4.js"><link rel="prefetch" href="/assets/js/112.331c4c5b.js"><link rel="prefetch" href="/assets/js/113.e3417205.js"><link rel="prefetch" href="/assets/js/114.a0ff7d55.js"><link rel="prefetch" href="/assets/js/115.0db92e36.js"><link rel="prefetch" href="/assets/js/116.71ec507b.js"><link rel="prefetch" href="/assets/js/117.5b78c86b.js"><link rel="prefetch" href="/assets/js/118.8152a57e.js"><link rel="prefetch" href="/assets/js/119.1719ff74.js"><link rel="prefetch" href="/assets/js/12.64c1a6b4.js"><link rel="prefetch" href="/assets/js/120.e444570a.js"><link rel="prefetch" href="/assets/js/121.098c6506.js"><link rel="prefetch" href="/assets/js/122.24d8d152.js"><link rel="prefetch" href="/assets/js/123.650654cc.js"><link rel="prefetch" href="/assets/js/13.6a0fe7be.js"><link rel="prefetch" href="/assets/js/14.64543860.js"><link rel="prefetch" href="/assets/js/15.8901664b.js"><link rel="prefetch" href="/assets/js/16.c1e7d229.js"><link rel="prefetch" href="/assets/js/17.77cc2cb1.js"><link rel="prefetch" href="/assets/js/18.81b866d8.js"><link rel="prefetch" href="/assets/js/19.904bd8ad.js"><link rel="prefetch" href="/assets/js/20.eb688fb1.js"><link rel="prefetch" href="/assets/js/21.4636dec3.js"><link rel="prefetch" href="/assets/js/22.1df94e1e.js"><link rel="prefetch" href="/assets/js/23.75e3ceaf.js"><link rel="prefetch" href="/assets/js/24.2a1b9b48.js"><link rel="prefetch" href="/assets/js/25.d633a47c.js"><link rel="prefetch" href="/assets/js/26.d4949d4a.js"><link rel="prefetch" href="/assets/js/27.dbd969a1.js"><link rel="prefetch" href="/assets/js/28.4ef6e72e.js"><link rel="prefetch" href="/assets/js/29.53b13f26.js"><link rel="prefetch" href="/assets/js/3.abffde0a.js"><link rel="prefetch" href="/assets/js/30.9f245bfa.js"><link rel="prefetch" href="/assets/js/31.80df994e.js"><link rel="prefetch" href="/assets/js/32.eb50701d.js"><link rel="prefetch" href="/assets/js/33.ba3f9774.js"><link rel="prefetch" href="/assets/js/34.28c7ab73.js"><link rel="prefetch" href="/assets/js/35.0c6d7368.js"><link rel="prefetch" href="/assets/js/36.79384b5e.js"><link rel="prefetch" href="/assets/js/37.2ae840a3.js"><link rel="prefetch" href="/assets/js/38.2afeab7d.js"><link rel="prefetch" href="/assets/js/39.6ec434d1.js"><link rel="prefetch" href="/assets/js/4.75b5f311.js"><link rel="prefetch" href="/assets/js/40.f8c49a72.js"><link rel="prefetch" href="/assets/js/41.5f80bbc8.js"><link rel="prefetch" href="/assets/js/42.39e8e78f.js"><link rel="prefetch" href="/assets/js/43.abd06211.js"><link rel="prefetch" href="/assets/js/44.7efe784f.js"><link rel="prefetch" href="/assets/js/45.ac67ddb0.js"><link rel="prefetch" href="/assets/js/46.4f10f1ea.js"><link rel="prefetch" href="/assets/js/47.80e6b6d5.js"><link rel="prefetch" href="/assets/js/48.a3d7ba89.js"><link rel="prefetch" href="/assets/js/49.2cd3da9b.js"><link rel="prefetch" href="/assets/js/5.b1bd6583.js"><link rel="prefetch" href="/assets/js/50.313b7204.js"><link rel="prefetch" href="/assets/js/51.7dfb52a5.js"><link rel="prefetch" href="/assets/js/52.6a2b5772.js"><link rel="prefetch" href="/assets/js/53.a1dd240e.js"><link rel="prefetch" href="/assets/js/54.767d98fd.js"><link rel="prefetch" href="/assets/js/55.ecc743b0.js"><link rel="prefetch" href="/assets/js/56.30d30eef.js"><link rel="prefetch" href="/assets/js/57.f2d191bd.js"><link rel="prefetch" href="/assets/js/58.e832c02e.js"><link rel="prefetch" href="/assets/js/59.5d304167.js"><link rel="prefetch" href="/assets/js/6.f8094df3.js"><link rel="prefetch" href="/assets/js/60.48889610.js"><link rel="prefetch" href="/assets/js/61.bf7d02c8.js"><link rel="prefetch" href="/assets/js/62.14378ac5.js"><link rel="prefetch" href="/assets/js/63.ef3c3d3a.js"><link rel="prefetch" href="/assets/js/64.901592a0.js"><link rel="prefetch" href="/assets/js/65.bad2d779.js"><link rel="prefetch" href="/assets/js/66.378f6e8f.js"><link rel="prefetch" href="/assets/js/67.ec09ac60.js"><link rel="prefetch" href="/assets/js/68.cc7b6d2c.js"><link rel="prefetch" href="/assets/js/69.00895e3a.js"><link rel="prefetch" href="/assets/js/7.ce46bcbe.js"><link rel="prefetch" href="/assets/js/70.1dabbc26.js"><link rel="prefetch" href="/assets/js/71.b43ff0fe.js"><link rel="prefetch" href="/assets/js/72.34f7a05b.js"><link rel="prefetch" href="/assets/js/73.b5d226b6.js"><link rel="prefetch" href="/assets/js/74.97a18875.js"><link rel="prefetch" href="/assets/js/75.f7b353d0.js"><link rel="prefetch" href="/assets/js/76.23c448fd.js"><link rel="prefetch" href="/assets/js/77.c2b9b145.js"><link rel="prefetch" href="/assets/js/78.e8759be0.js"><link rel="prefetch" href="/assets/js/79.ef3ffb13.js"><link rel="prefetch" href="/assets/js/8.e17184ad.js"><link rel="prefetch" href="/assets/js/80.12c0ca15.js"><link rel="prefetch" href="/assets/js/81.cee5a26a.js"><link rel="prefetch" href="/assets/js/82.6c0a3c70.js"><link rel="prefetch" href="/assets/js/83.cf0a304b.js"><link rel="prefetch" href="/assets/js/85.278aa192.js"><link rel="prefetch" href="/assets/js/86.3e927992.js"><link rel="prefetch" href="/assets/js/87.30b13d6e.js"><link rel="prefetch" href="/assets/js/88.e665becc.js"><link rel="prefetch" href="/assets/js/89.7a7d67d5.js"><link rel="prefetch" href="/assets/js/9.b122435d.js"><link rel="prefetch" href="/assets/js/90.55adce3b.js"><link rel="prefetch" href="/assets/js/91.a4fc30fb.js"><link rel="prefetch" href="/assets/js/92.9b9042e6.js"><link rel="prefetch" href="/assets/js/93.7bb892da.js"><link rel="prefetch" href="/assets/js/94.61b61e07.js"><link rel="prefetch" href="/assets/js/95.209bf20d.js"><link rel="prefetch" href="/assets/js/96.64859f5c.js"><link rel="prefetch" href="/assets/js/97.e1a94f33.js"><link rel="prefetch" href="/assets/js/98.56ac290c.js"><link rel="prefetch" href="/assets/js/99.1185de91.js">
    <link rel="stylesheet" href="/assets/css/0.styles.35bcedcf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="ZTBCMS" class="logo"> <span class="site-name can-hide">ZTBCMS</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/SUMMARY.html" class="nav-link">
  目录
</a></div><div class="nav-item"><a href="/basic/" class="nav-link">
  起步
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  框架
</a></div><div class="nav-item"><a href="/best_practic/" class="nav-link">
  最佳实践
</a></div><div class="nav-item"><a href="/module/" class="nav-link router-link-active">
  模块
</a></div><div class="nav-item"><a href="/extra/" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/case.html" class="nav-link">
  案例
</a></div> <a href="https://github.com/ztbcms/ztbcms/tree/v3" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/SUMMARY.html" class="nav-link">
  目录
</a></div><div class="nav-item"><a href="/basic/" class="nav-link">
  起步
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  框架
</a></div><div class="nav-item"><a href="/best_practic/" class="nav-link">
  最佳实践
</a></div><div class="nav-item"><a href="/module/" class="nav-link router-link-active">
  模块
</a></div><div class="nav-item"><a href="/extra/" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/case.html" class="nav-link">
  案例
</a></div> <a href="https://github.com/ztbcms/ztbcms/tree/v3" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>云存储模块 !version</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/module/oss/#云存储模块" class="sidebar-link">云存储模块 !version</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/module/oss/#是什么" class="sidebar-link">是什么</a></li><li class="sidebar-sub-header"><a href="/module/oss/#配置" class="sidebar-link">配置</a></li><li class="sidebar-sub-header"><a href="/module/oss/#上传凭证" class="sidebar-link">上传凭证</a></li><li class="sidebar-sub-header"><a href="/module/oss/#阿里云-直接上传" class="sidebar-link">阿里云 直接上传</a></li><li class="sidebar-sub-header"><a href="/module/oss/#七牛云-直接上传" class="sidebar-link">七牛云 直接上传</a></li><li class="sidebar-sub-header"><a href="/module/oss/#镜像备份" class="sidebar-link">镜像备份</a></li><li class="sidebar-sub-header"><a href="/module/oss/#使用镜像备份" class="sidebar-link">使用镜像备份</a></li><li class="sidebar-sub-header"><a href="/module/oss/#阿里云-镜像回源" class="sidebar-link">阿里云 镜像回源</a></li><li class="sidebar-sub-header"><a href="/module/oss/#七牛云-镜像存储" class="sidebar-link">七牛云 镜像存储</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="云存储模块"><a href="#云存储模块" class="header-anchor">#</a> 云存储模块 <img src="https://img.shields.io/github/release/ztbcms/ztbcms-Oss.svg?maxAge=36000" alt="version"></h2> <h3 id="是什么"><a href="#是什么" class="header-anchor">#</a> 是什么</h3> <p>本模块用于上传文件，暂支持「阿里云」与「七牛云」两种云存储。</p> <h3 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h3> <p>模块安装后，需要配置一些参数，包括AK（AccessKey），SK（AccessKeySecret），阿里云的 endpoint，以及 七牛云的 domain。</p> <h4 id="阿里云"><a href="#阿里云" class="header-anchor">#</a> 阿里云</h4> <p>阿里云的设置比较繁琐，建议直接阅读官方文档</p> <p>官方文档：<a href="https://help.aliyun.com/document_detail/31932.html?spm=5176.doc31931.6.646.Ie3E9Z" target="_blank" rel="noopener noreferrer">https://help.aliyun.com/document_detail/31932.html?spm=5176.doc31931.6.646.Ie3E9Z<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>endpoint 表示 OSS 对外服务的访问域名。OSS 以 HTTP RESTful API 的形式对外提供服务，当访问不同的 Region 的时候，需要不同的域名。通过内网和外网访问同一个 Region 所需要的 Endpoint 也是不同的。进入 OSS 服务，点击指定的存储空间即可获取。</p> <p><img src="https://dn-coding-net-production-pp.qbox.me/84da9f89-b201-4c2f-9c80-446455398622.png" alt="图片"></p> <h4 id="七牛云"><a href="#七牛云" class="header-anchor">#</a> 七牛云</h4> <p>七牛云登录管理后台，进入个人中心，点击秘钥管理，即可获取密钥。</p> <p><img src="https://dn-coding-net-production-pp.qbox.me/61be23d5-3ba2-46c7-b9e8-a86fab468933.png" alt="图片"></p> <p>domain 是七牛云对外的访问域名，每个存储空间对外的域名都是不一样的，这个不需要配置，但是在后台生成上传配置的时候需要用到，进入指定的存储空间的内容管理中可获取此访问域名。</p> <p><img src="https://dn-coding-net-production-pp.qbox.me/82dc2f67-7fb1-496c-8459-32120fd71807.png" alt="图片"></p> <h3 id="上传凭证"><a href="#上传凭证" class="header-anchor">#</a> 上传凭证</h3> <p>为了安全，不管是「阿里云」还是「七牛云」，上传都是需要验证权限的。</p> <p>虽然两者都支持前端直接鉴权生成凭证，但这样做就把生成凭证的密钥暴漏了，所以建议使用后台签名，返回上传凭证的方式。</p> <p>获取上传的凭证的链接由后台提供，前端直接请求即可。</p> <h3 id="阿里云-直接上传"><a href="#阿里云-直接上传" class="header-anchor">#</a> 阿里云 直接上传</h3> <h4 id="前端"><a href="#前端" class="header-anchor">#</a> 前端</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//授权链接，此链接由后台提供</span>
<span class="token keyword">var</span> get_token_url <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> OssData <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">//获取凭证</span>
<span class="token keyword">function</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>OssData <span class="token operator">||</span> OssData<span class="token punctuation">.</span>expire <span class="token operator">&lt;</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token operator">:</span> get_token_url<span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
            dataType<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
            async<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token comment">//使用同步请求，保证 token 的可靠性，如不考虑兼容低版本的浏览器，这里考虑直接使用 async/await</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                OssData <span class="token operator">=</span> res<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//上传</span>
<span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加签名信息</span>
        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'OSSAccessKeyId'</span><span class="token punctuation">,</span> OssData<span class="token punctuation">.</span>accessid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'policy'</span><span class="token punctuation">,</span> OssData<span class="token punctuation">.</span>policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'Signature'</span><span class="token punctuation">,</span> OssData<span class="token punctuation">.</span>signature<span class="token punctuation">)</span><span class="token punctuation">;</span>
        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> OssData<span class="token punctuation">.</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'success_action_status'</span><span class="token punctuation">,</span> <span class="token string">'201'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加文件</span>
        <span class="token keyword">var</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> file<span class="token punctuation">,</span> file<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token operator">:</span> OssData<span class="token punctuation">.</span>host<span class="token punctuation">,</span>
            data<span class="token operator">:</span> formData<span class="token punctuation">,</span>
            dataType<span class="token operator">:</span> <span class="token string">'xml'</span><span class="token punctuation">,</span>
            processData<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            contentType<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'PostResponse'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'PostResponse'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 文件地址</span>
                    <span class="token keyword">var</span> url <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                    <span class="token comment">//do string</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="后端"><a href="#后端" class="header-anchor">#</a> 后端</h4> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">//返回 token </span>
<span class="token keyword">function</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$expire_time</span> <span class="token operator">=</span> <span class="token number">1800</span><span class="token punctuation">;</span>
    <span class="token class-name static-context">AliOssService</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token variable">$expire_time</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$bucket</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'ztb-open'</span><span class="token punctuation">;</span> <span class="token comment">//存储空间名</span>
    <span class="token variable">$dir</span>    <span class="token operator">=</span> <span class="token string single-quoted-string">'ztb-open/'</span><span class="token punctuation">;</span><span class="token comment">//文件前缀，如果以/结尾，则新建目录</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">ajaxReturn</span><span class="token punctuation">(</span><span class="token class-name static-context">AliOssService</span><span class="token operator">::</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token variable">$bucket</span><span class="token punctuation">,</span> <span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>详细例子可见模块中的 AliyunOssTestController</p> <h3 id="七牛云-直接上传"><a href="#七牛云-直接上传" class="header-anchor">#</a> 七牛云 直接上传</h3> <h4 id="前端-2"><a href="#前端-2" class="header-anchor">#</a> 前端</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//授权链接，此链接由后台提供</span>
<span class="token keyword">var</span> get_token_url <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> OssData <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">//获取凭证</span>
<span class="token keyword">function</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>OssData <span class="token operator">||</span> OssData<span class="token punctuation">.</span>expire <span class="token operator">&lt;</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token operator">:</span> get_token_url<span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
            dataType<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
            async<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token comment">//使用同步请求，保证 token 的可靠性，如不考虑兼容低版本的浏览器，这里考虑直接使用 async/await</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                OssData <span class="token operator">=</span> res<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//上传</span>
<span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// token</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> OssData<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// file</span>
    <span class="token keyword">var</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> file<span class="token punctuation">,</span> file<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>


    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url<span class="token operator">:</span> <span class="token string">'http://up.qiniu.com'</span><span class="token punctuation">,</span>
        type<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> formData<span class="token punctuation">,</span>
        processData<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        contentType<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        dataType<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 文件地址</span>
            <span class="token keyword">var</span> url <span class="token operator">=</span> res<span class="token punctuation">.</span>url<span class="token punctuation">;</span>

            <span class="token comment">//do string</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="后端-2"><a href="#后端-2" class="header-anchor">#</a> 后端</h4> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">//返回 token </span>
<span class="token keyword">function</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$expire_time</span> <span class="token operator">=</span> <span class="token number">1800</span><span class="token punctuation">;</span>
    <span class="token class-name static-context">QiniuService</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token variable">$expire_time</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$bucket</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'xxx'</span><span class="token punctuation">;</span> <span class="token comment">//指定存储空间名</span>
    <span class="token variable">$domain</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'http://xxxx/'</span><span class="token punctuation">;</span><span class="token comment">//存储空间外网访问链接，需以/结尾</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">ajaxReturn</span><span class="token punctuation">(</span><span class="token class-name static-context">QiniuService</span><span class="token operator">::</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token variable">$bucket</span><span class="token punctuation">,</span> <span class="token variable">$domain</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>详细例子可见模块中的 QiniuTestController</p> <h3 id="镜像备份"><a href="#镜像备份" class="header-anchor">#</a> 镜像备份</h3> <p>由于历史遗留问题，已存在的项目可能没有接入云存储，而且已经产生了业务数据，如果需要接入云存储，但是不希望进行麻烦的数据迁移，可以通过云存储提供的镜像备份服务来完成数据的无缝迁移。</p> <p>镜像备份的原理是，当客户端请求的资源在存储云上不存在时，存储云根据服务配置，把请求重定向到配置源，或者主动前往配置源中下载请求资源并存储到存储云中。</p> <p>当配置源中也找不到指定资源时，云存储返回资源不存在。</p> <h3 id="使用镜像备份"><a href="#使用镜像备份" class="header-anchor">#</a> 使用镜像备份</h3> <p>当启用了镜像备份之后，文件的上传就无须上传到云存储服务了，只需要直接上传到源服务器中，当有请求时，云存储服务会自动抓取资源，并下载到云存储服务中去。</p> <h3 id="阿里云-镜像回源"><a href="#阿里云-镜像回源" class="header-anchor">#</a> 阿里云 镜像回源</h3> <p>阿里云的镜像备份称作「镜像回源」，开启方式为，进入指定的云存储空间，选择基础设置，滚动到底部找到，「镜像回源」，点击设置，进入回源设置，并创建规则即可，阿里云支持最多5条回源规则，规则匹配顺序为顺序匹配。</p> <p><img src="https://dn-coding-net-production-pp.qbox.me/3202db45-3227-4903-b938-523005964bc0.png" alt="图片">
参考文档： <a href="https://help.aliyun.com/document_detail/31865.html" target="_blank" rel="noopener noreferrer">https://help.aliyun.com/document_detail/31865.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="七牛云-镜像存储"><a href="#七牛云-镜像存储" class="header-anchor">#</a> 七牛云 镜像存储</h3> <p>七牛云的镜像备份称作「镜像存储」，开启方式为，进入指定的存储空间，选择镜像存储，配置镜像源地址即可，七牛云只支持一个源地址转发规则。</p> <p><img src="https://dn-coding-net-production-pp.qbox.me/027f539d-5689-4ec4-9cdc-7256e64ee69d.png" alt="图片"></p> <p>参考文档： <a href="https://developer.qiniu.com/kodo/kb/1376/seven-cattle-image-storage-instruction-manuals" target="_blank" rel="noopener noreferrer">https://developer.qiniu.com/kodo/kb/1376/seven-cattle-image-storage-instruction-manuals<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ztbcms/docs/edit/develop/docs/module/oss/readme.md" target="_blank" rel="noopener noreferrer">编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">更新于:</span> <span class="time">1/12/2018, 5:57:16 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.dfdc7237.js" defer></script><script src="/assets/js/2.337bf37a.js" defer></script><script src="/assets/js/84.b52b4bd1.js" defer></script>
  </body>
</html>
